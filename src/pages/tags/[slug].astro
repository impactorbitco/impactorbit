---
import Layout from '../../layouts/Layout.astro';
import InsightsGrid from '../../components/InsightsGrid.jsx';
import { getCollection } from 'astro:content';
import { SDGs } from '../../data/sdgs';
import { slug as slugify } from 'github-slugger';

/* -------------------------------------------
   Static paths: generate one page per unique tag
-------------------------------------------- */
export async function getStaticPaths() {
  const posts = await getCollection('blog'); // use 'blog' collection
  const tagsSet = new Set();

  posts.forEach(post => {
    if (Array.isArray(post.data.tags)) {
      post.data.tags.forEach(tag => tagsSet.add(tag.trim()));
    }
  });

  return Array.from(tagsSet).map(tag => ({
    params: { slug: slugify(tag) }
  }));
}

/* -------------------------------------------
   Runtime: filter posts by tag
-------------------------------------------- */
const { slug: paramSlug } = Astro.params;
const posts = await getCollection('blog');

// Filter posts that include this tag
const tagPosts = posts.filter(post => 
  Array.isArray(post.data.tags) &&
  post.data.tags.some(t => slugify(t).toLowerCase() === paramSlug.toLowerCase())
);

// Normalize for InsightsGrid
const allInsights = tagPosts.map(post => {
  const sdgCodes = Array.isArray(post.data.SDGs)
    ? post.data.SDGs.map(n => `SDG ${String(n).padStart(2,'0')}`)
    : typeof post.data.SDGs === 'number'
    ? [`SDG ${String(post.data.SDGs).padStart(2,'0')}`]
    : [];

  return {
    ...post,
    collection: 'blog',
    data: {
      ...post.data,
      SDGs: sdgCodes,
      contentType: 'blog',
      organisations: post.data.organisations || [],
      title: post.data.title || '(Untitled)',
    },
  };
});

// SDG mapping (for potential use in InsightsGrid)
const sdgMap = SDGs.reduce((acc, sdg) => {
  const code = `SDG ${String(sdg.id).padStart(2,'0')}`;
  acc[code.toUpperCase()] = sdg;
  return acc;
}, {});

// Display the canonical tag (original casing)
const displayTag = tagPosts.length > 0 
  ? tagPosts[0].data.tags.find(t => slugify(t) === paramSlug) 
  : paramSlug;
---

<Layout title={`Posts tagged: ${displayTag}`} description={`Browse posts tagged with "${displayTag}"`}>
  <!-- Hero Section -->
  <section class="py-24 text-center bg-secondary-500 text-white">
    <h1 class="text-5xl sm:text-6xl font-extrabold mb-4">{displayTag}</h1>
    <p class="text-lg sm:text-xl max-w-2xl mx-auto">
      Explore all blog posts under the "{displayTag}" tag. Insights across sustainability, space, and innovation.
    </p>
  </section>

  <!-- Posts Grid -->
  <main class="py-12 w-full max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8">
    {allInsights.length > 0 ? (
      <InsightsGrid client:load posts={allInsights} />
    ) : (
      <p class="text-center text-gray-500 text-lg mt-12">No posts found for this tag.</p>
    )}
  </main>

  <!-- CTA Section -->
  <section class="mt-16 py-16 bg-accent-500 text-white text-center w-full">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-3xl sm:text-4xl font-bold mb-4">Stay Updated on Sustainable Space</h2>
      <p class="mb-8 text-lg sm:text-xl text-gray-200">
        Subscribe to our newsletter for the latest insights on space, sustainability, and innovation.
      </p>
      <a
        href="/newsletter"
        class="inline-block px-8 py-4 bg-white text-accent-600 font-semibold rounded-lg hover:bg-gray-100 transition text-lg sm:text-xl"
      >
        Subscribe Now
      </a>
    </div>
  </section>
</Layout>