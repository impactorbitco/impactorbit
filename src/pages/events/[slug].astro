---
import Layout from '../../layouts/Layout.astro';
import EventDescription from '../../components/EventDescription.jsx';
import events from '../../data/events.json';
import slugify from '../../utils/slugify.js';
import { buildEventSchema, fallbackIcon, sdgMap, Event } from '../../components/Schema/EventSchema';

export async function getStaticPaths() {
  return events.map(e => ({
    params: { slug: e.slug || slugify(e.title) },
  }));
}

const { slug } = Astro.params;
const event = events.find(e => (e.slug || slugify(e.title)) === slug);
if (!event) throw new Error(`No event found with slug: ${slug}`);

function formatDate(dateStr: string | undefined) {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  return isNaN(date.getTime())
    ? dateStr
    : date.toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' });
}

function getEventSlug(e: Event) {
  return e.slug || slugify(e.title);
}

const normalizedEvent: Event = {
  slug: event.slug || slugify(event.title),
  title: event.title || 'Untitled Event',
  description: event.description || '',
  start: event.start,
  end: event.end,
  location: event.location && event.location !== '-' ? event.location : 'TBD',
  organizer: event.organizer || 'TBD',
  organizer_url: event.organizer_url || '',
  status: event.status || 'TBD',
  categories: event.categories || [],
  tags: event.tags || event.categories || [],
  url: event.url || '',
  image: event.image || event.image_url || '',
  calendar_links: event.calendar_links || [],
  sdgs: event.sdgs || [],
  price: event.price || null,
  currency: event.currency || 'GBP',
};

const eventIndex = events.findIndex(e => (e.slug || slugify(e.title)) === slug);
const prevEvent = events[eventIndex - 1] || null;
const nextEvent = events[eventIndex + 1] || null;

const eventSchema = buildEventSchema(normalizedEvent);
---

<Layout title={normalizedEvent.title} schema={[eventSchema]}>

  <!-- Hero Section -->
  <section class="relative w-full h-[500px] sm:h-[600px] lg:h-[700px] flex items-center justify-center overflow-hidden">
    <div
      class="absolute inset-0 bg-cover bg-center"
      style={`background-image: url(${normalizedEvent.image || '/images/default-event-hero.jpg'});`}
      aria-hidden="true"
    />
    <div class="absolute inset-0 bg-black/50" aria-hidden="true"></div>
    <div class="relative z-10 text-center px-4 sm:px-6 lg:px-8 max-w-4xl space-y-6">
      <h1 class="text-5xl sm:text-6xl lg:text-7xl font-extrabold text-white drop-shadow-lg">
        {normalizedEvent.title}
      </h1>
      {normalizedEvent.subtitle && (
        <p class="text-2xl sm:text-3xl text-gray-200 drop-shadow">
          {normalizedEvent.subtitle}
        </p>
      )}
      {normalizedEvent.start && (
        <p class="text-gray-200 drop-shadow">
          {formatDate(normalizedEvent.start)}
          {normalizedEvent.end ? ` â€“ ${formatDate(normalizedEvent.end)}` : ''}
        </p>
      )}
    </div>
  </section>

  <!-- Meta Info -->
  <section class="flex flex-wrap gap-4 max-w-4xl mx-auto px-4 mt-4">
    {normalizedEvent.organizer && (
      <span class="inline-block bg-accent-500 text-white px-4 py-2 rounded font-semibold text-sm">
        {normalizedEvent.organizer}
      </span>
    )}
    {normalizedEvent.location && (
      <span class="inline-block bg-gray-700 text-white px-4 py-2 rounded font-semibold text-sm">
        {normalizedEvent.location}
      </span>
    )}
    {normalizedEvent.sdgs.length > 0 && (
      <div class="flex flex-wrap gap-2">
        {normalizedEvent.sdgs.sort((a,b)=>a-b).map(id => (
          <img
            key={id}
            src={sdgMap[id]?.icon || fallbackIcon}
            alt={sdgMap[id]?.name || `SDG ${id}`}
            title={sdgMap[id]?.name || `SDG ${id}`}
            class="w-10 h-10 rounded-sm cursor-pointer"
            onClick={`window.location='/events/?sdg=${id}'`}
          />
        ))}
      </div>
    )}
  </section>

  <main class="py-12 max-w-4xl mx-auto px-4 space-y-8">

    <section class="space-y-4">
      <EventDescription description={normalizedEvent.description} />
      {normalizedEvent.url && (
        <a
          href={normalizedEvent.url}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-block bg-accent-500 hover:bg-accent-600 text-white py-2 px-4 rounded transition"
        >
          Event Page
        </a>
      )}
    </section>

    <!-- Venue Google Maps -->
    {normalizedEvent.location && !['tbd','online'].includes(normalizedEvent.location.toLowerCase()) && (
      <iframe
        class="w-full h-64 mt-4 rounded"
        src={`https://www.google.com/maps?q=${encodeURIComponent(normalizedEvent.location)}&output=embed`}
        loading="lazy"
      />
    )}

    <!-- Navigation -->
    <section class="flex flex-col sm:flex-row justify-between gap-4 mt-8">
      {prevEvent && (
        <a href={`/events/${getEventSlug(prevEvent)}/`} class="btn bg-accent-500 hover:bg-accent-600 text-white py-2 px-4 rounded flex-1 text-center transition">
          &larr; Previous Event
        </a>
      )}
      <a href="/events/" class="btn bg-gray-500 hover:bg-accent-600 text-white py-2 px-4 rounded flex-1 text-center transition">
        Back to Events
      </a>
      {nextEvent && (
        <a href={`/events/${getEventSlug(nextEvent)}/`} class="btn bg-accent-500 hover:bg-accent-600 text-white py-2 px-4 rounded flex-1 text-center transition">
          Next Event &rarr;
        </a>
      )}
    </section>
  </main>

  <!-- Full-Width CTA -->
  <section class="w-full bg-secondary-500 py-16 text-white text-center">
    <div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-2xl sm:text-3xl font-bold mb-4">Enjoyed this insight?</h2>
      <p class="mb-6">Subscribe to our newsletter for updates on sustainable space operations and research.</p>
      <a href="/newsletter" class="inline-block bg-white text-accent-600 font-semibold px-6 py-3 rounded-md hover:bg-gray-100 transition">
        Subscribe Now
      </a>
    </div>
  </section>

</Layout>