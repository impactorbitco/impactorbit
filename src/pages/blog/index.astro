---
import Layout from '../../layouts/Layout.astro';
import Hero from '../../components/Hero.astro';
import InsightsGrid from '../../components/InsightsGrid.jsx';
import { getCollection } from 'astro:content';
import organisations from '../../data/organisations.json';
import { slug as slugify } from 'github-slugger';
import { SDGs } from '../../data/sdgs';

/* -------------------------------------------
   Load blog collection
-------------------------------------------- */
const collectionName = 'blog';
let entries = await getCollection(collectionName);

// Normalize tags
entries.forEach(entry => {
  if (entry.data.tags) entry.data.tags = entry.data.tags.map(tag => tag.trim());
});

// Sort by pubdate descending
entries = entries.sort((a, b) => {
  if (!a.data.pubdate) return 1;
  if (!b.data.pubdate) return -1;
  return new Date(b.data.pubdate) - new Date(a.data.pubdate);
});

// Map organisations to slugs
const orgSlugMap = {};
organisations.forEach(org => {
  orgSlugMap[org.organisation] = org.slug;
});

// Normalize entries for InsightsGrid
const allInsights = entries.map(entry => {
  const orgs = Array.isArray(entry.data.organisations)
    ? entry.data.organisations.map(name => ({
        name,
        slug: orgSlugMap[name] || slugify(name),
      }))
    : [];

  return {
    ...entry,
    data: {
      ...entry.data,
      organisations: orgs,
      contentType: 'blog',
      pubdate: entry.data.pubdate || null,
      title: entry.data.title || '(Untitled)',
    },
    collection: collectionName,
  };
});

// SDG map for InsightsGrid
const sdgMap = SDGs.reduce((acc, sdg) => {
  const code = `SDG ${String(sdg.id).padStart(2,'0')}`;
  acc[code.toUpperCase()] = sdg;
  return acc;
}, {});
---

<Layout title="Blog" description="Explore our latest blog posts on sustainable space operations.">

  <main class="py-12 w-full">
    <Hero
      title="Blog"
      description="Explore our latest blog posts on sustainability, space, and innovation."
    />

    <div class="w-full px-4 md:px-8 lg:px-12">
      <!-- Insights Grid with SDG filter, search, and full-width cards -->
      <InsightsGrid client:load posts={allInsights} />
    </div>

    <!-- CTA Section -->
    <section class="mt-16 py-16 bg-secondary-500 text-white text-center w-full">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-3xl sm:text-4xl font-bold mb-4">Stay Updated on Sustainable Space</h2>
        <p class="mb-8 text-lg sm:text-xl text-gray-200">
          Subscribe to our newsletter for the latest insights on space, sustainability, and innovation.
        </p>
        <a
          href="/newsletter"
          class="inline-block px-8 py-4 bg-accent-500 hover:bg-accent-600 text-white font-semibold rounded-lg transition text-lg sm:text-xl"
        >
          Subscribe Now
        </a>
      </div>
    </section>
  </main>
</Layout>